{% extends "base.html" %}
{% block content %}
<h2 class="h3 mb-3">AR Tours (Beta)</h2>
<p class="text-muted">Move your phone around to detect location. Nearby POIs appear as floating labels. Grant camera & location permissions. Best on mobile.</p>

<!-- A-Frame + AR.js (location-based) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

<div class="ratio ratio-16x9 rounded-4 overflow-hidden shadow-sm border">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; trackingMethod: best;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
    <!-- POIs injected by JS -->
  </a-scene>
</div>

<script>
  // Fetch POIs and add gps-entity-place markers
  fetch("{{ url_for('api_poi') }}")
    .then(r => r.json())
    .then(pois => {
      const scene = document.querySelector("a-scene");
      pois.forEach(p => {
        const el = document.createElement("a-entity");
        el.setAttribute("gps-entity-place", `latitude: ${p.lat}; longitude: ${p.lng};`);
        el.setAttribute("look-at", "[gps-camera]");
        el.setAttribute("text", `value: ${p.name}; align: center; width: 8; color: #fff;`);
        el.setAttribute("geometry", "primitive: plane; height: 0.6; width: 3");
        el.setAttribute("material", "color: #0d6efd; opacity: 0.85");
        el.setAttribute("position", "0 2 0");
        el.addEventListener("loaded", () => window.dispatchEvent(new CustomEvent("gps-entity-place-loaded")));
        scene.appendChild(el);
      });
    });
</script>
{% endblock %}